generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// SQLite does not support Json or enums in Prisma.
// Store JSON as TEXT (String), and roles/status as String.

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  fullName     String
  role         String   @default("HOST")
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  hostedVisits  Visit[] @relation("HostVisits")
  createdVisits Visit[] @relation("CreatedByVisits")
  actedEvents   Event[] @relation("ActorEvents")
}

model Visitor {
  id        String   @id @default(cuid())
  fullName  String
  idNumber  String
  email     String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  visits    Visit[]

  @@index([idNumber])
}

model Visit {
  id              String   @id @default(cuid())
  code            String   @unique
  status          String   @default("REGISTERED")
  purpose         String
  destination     String
  numPeople       Int      @default(1)
  vehiclePlate    String?

  questionnaire   String   @default("{}")

  checkInAt       DateTime?
  checkoutStartAt DateTime?
  exitConfirmedAt DateTime?

  visitorId       String
  visitor         Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  hostUserId      String?
  host            User?    @relation("HostVisits", fields: [hostUserId], references: [id], onDelete: SetNull)

  createdByUserId String?
  createdBy       User?    @relation("CreatedByVisits", fields: [createdByUserId], references: [id], onDelete: SetNull)

  events          Event[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([checkInAt])
  @@index([checkoutStartAt])
}

model Event {
  id          String   @id @default(cuid())
  type        String
  note        String?
  meta        String   @default("{}")
  createdAt   DateTime @default(now())

  visitId     String
  visit       Visit    @relation(fields: [visitId], references: [id], onDelete: Cascade)

  actorUserId String?
  actorUser   User?    @relation("ActorEvents", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([type])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  role      String   @default("SECURITY")
  title     String
  body      String
  level     String   @default("info")
  visitCode String?
  readAt    DateTime?
  createdAt DateTime @default(now())

  @@index([role, readAt])
  @@index([createdAt])
}
